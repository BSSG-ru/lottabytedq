## <a id="title1">Модуль проверки качества Lottabyte</a>

 
Модуль проверки качества Lottabyte содержит утилиты для выполнения правил проверки качества.
- `openlineage-log.py` - программа обработки сообщений [openlineage](<https://openlineage.io>).
- `dq_utils.py` - правила проверки качества.
- `dq_scheduler.py` - программа выполнения оперативных проверок качества.
- `api.py` - API для правил проверки качества.
- `dq_kafka_subscriber.py` - программа проверки качества из очередей kafka.

Запуск программ выполняется без параметров `python <имя программы>`

Библиотеки необходимые для работы системы указаны в файле `requirements.txt`.

## Описание настроек

Настройки проверок качества находятся в файле settings.json
- dq_email_list: перечень почтовых адресов рассылки ошибок проверки качества,
- env: среда развертывания,
- error_email_list: перечень почтовых адресов рассылки общих ошибок процесса интеграции,
- exception_email_list: перечень почтовых адресов рассылки исключений,
- pg_database: название БД,
- pg_exceptions_table: таблица с исключениями,
- pg_host: сервер базы данных,
- pg_password: пароль для подключения к базе данных,
- pg_port: порт базы данных,
- pg_schema: схема в базе данных,
- pg_username: имя пользователя для подключения к базе данных,
- smtp_host: хост рассылки почтовых уведомлений,
- smtp_login: имя пользователя рассылки почтовых уведомлений,
- smtp_password: пароль пользователя рассылки почтовых уведомлений,
- smtp_port: порт сервера рассылки почтовых уведомлений,
- open_linage_path: путь к библиотеке [openlineage](<https://openlineage.io>),
- tenant: тенант в Lottabyte,
- kafka_producer_topic: топик kafka, который является интерфейсом обработки openlineage-log.py,
- kafka_producer: название продюсера правил проверки качества в инфраструктуре фреймворка [openlineage](<https://openlineage.io>),
- kafka_bootstrap_servers: сервер:порт kafka,
- kafka_namespace: пространство имен [openlineage](<https://openlineage.io>).

## Правила проверки качества в Lottabyte

В Lottabyte ведется общий реестр проверок качества в разделе Правила проверки качества. Для каждого правила необходимо указать уникальное название правила, ссылку на функцию проверки качества, реализованную на языке python, опционально, можно указать пример настроек - это те параметры, которые будут переданы на вход функции проверке качества.
![Список правил в Lottabyte](https://storage.yandexcloud.net/lottabyte-doc/dq_rules.png)
Подключение правил проверки качества можно выполнить путем привязки их к объектам управления данными Lottabyte. Привязать правило можно к Показателю, Продукту или Активу.
![Пример привязки правила в Lottabyte](https://storage.yandexcloud.net/lottabyte-doc/dq_rules_product.png)

## Мониторинг проверки качества/процессов интеграции в Lottabyte

В Lottabyte встроен инструмент мониторинга телеметрии процессов интеграции, в том числе и проверок качества. Для доступа к данному разделу необходимо перейти в Мониторинг DQ раздела Правил проверки качества.

![Пример lineage в Lottabyte](https://storage.yandexcloud.net/lottabyte-doc/dq_rules_lineage.png)

В lineage процесса интеграции возможно провалиться в просмотр результатов проверок качества. 
Каждая проверка качества может завершится ошибкой, пройти успешно или определить предупреждение, в зависимости от этого
 определяется  цвет элемента в lineage.

 ![Пример детализации результатов проверки в lineage в Lottabyte](https://storage.yandexcloud.net/lottabyte-doc/dq_rules_lineage_checks.png)

 Для просмотра всех проверок введенных в систему и их связь с объектами Lottabyte.

 ![Свод правил проверки в Lottabyte](https://storage.yandexcloud.net/lottabyte-doc/dq_rules_lineage_tasks.png)

В Lottabyte есть возможность запустить проверку, которая запланирована на выполнение в определенное время, для этого нужно выбрать соответствующую проверку и кликнуть по ней 2 раза, после этого вы увидите диалоговое окно, которое покажет вам статус выполнения данной проверки.

## Установка сервисов качества

 - Установить Postgresql 11*,
 - Установить python 3*,
 - Установить зависимости `pip install -r requirements.txt`,
 - Развернуть в схеме нужного тенанта Lottabyte файл dump.sql.
 - Запустить службы из [раздела 1](#%D0%BC%D0%BE%D0%B4%D1%83%D0%BB%D1%8C-%D0%BF%D1%80%D0%BE%D0%B2%D0%B5%D1%80%D0%BA%D0%B8-%D0%BA%D0%B0%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%B0-lottabyte)